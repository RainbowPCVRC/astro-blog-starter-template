---
import BaseLayout from "../layouts/BaseLayout.astro";

const products = [
  {
    key: "gumroad",
    name: "Gumroad",
    href: "https://rainbowvis.gumroad.com",
    icon: "/icons/gumroad.png",
    image: "/images/products/gumroad-feature.png",
    blurb: "Digital downloads and packs."
  },
  {
    key: "jinxxy",
    name: "Jinxxy",
    href: "https://jinxxy.com/RainbowVis",
    icon: "/icons/jinxxy.png",
    image: "/images/products/jinxxy-feature.png",
    blurb: "VRChat assets and related listings."
  },
  {
    key: "kofi",
    name: "Ko-fi",
    href: "https://ko-fi.com/rainbowvis",
    icon: "/icons/kofi.png",
    image: "/images/products/kofi-feature.png",
    blurb: "Support and tips."
  }
];
---

<BaseLayout
  title={`${SITE_TITLE} • Products`}
  description="Stores, featured items, and support options."
>
  <section class="section-stack">
    <div class="neon-card proximity-glow">
      <div class="card-pad">
        <h1 class="card-title" style="font-size:2rem;">Products</h1>
        <p class="card-subtitle">Stores, featured items, and support options.</p>
      </div>
    </div>

    <div class="product-grid">
      {products.map((p) => (
        <article class="neon-card proximity-glow product-card">
          <div class="product-row">
            <div class="left">
              <div class="product-icon" aria-hidden="true">
                <img src={p.icon} alt="" loading="lazy" />
              </div>
              <div style="min-width:0;">
                <h2 class="card-title" style="margin:0;">{p.name}</h2>
                <p class="card-subtitle" style="margin:4px 0 0;">{p.blurb}</p>
              </div>
            </div>

            <div style="display:flex; gap:10px; align-items:center;">
              <a class="btn" href={p.href} target="_blank" rel="noreferrer">Open</a>
              <button class="btn" type="button" data-open={p.key}>Preview</button>
            </div>
          </div>

          <div class="product-image" role="button" tabindex="0" data-open={p.key} aria-label={`Preview ${p.name}`}>
            <img src={p.image} alt={`${p.name} preview`} loading="lazy" />
          </div>
        </article>
      ))}
    </div>
  </section>

  <!-- Lightbox (must be INSIDE the page, not after </html>) -->
  <div class="lightbox" id="lightbox" aria-hidden="true">
    <div class="lightbox-card" role="dialog" aria-modal="true" aria-label="Image preview">
      <div class="lightbox-bar">
        <h3 class="lightbox-title" id="lightboxTitle">Preview</h3>
        <button class="lightbox-close" id="lightboxClose" type="button" aria-label="Close">✕</button>
      </div>
      <div class="lightbox-image">
        <img id="lightboxImg" alt="Preview image" />
      </div>
    </div>
  </div>

  <script>
    const previewMap = {
      gumroad: { title: "Gumroad", image: "/images/products/gumroad-feature.png" },
      jinxxy: { title: "Jinxxy", image: "/images/products/jinxxy-feature.png" },
      kofi: { title: "Ko-fi", image: "/images/products/kofi-feature.png" },
    };

    const lb = document.getElementById("lightbox");
    const lbImg = document.getElementById("lightboxImg");
    const lbTitle = document.getElementById("lightboxTitle");
    const lbClose = document.getElementById("lightboxClose");

    function openLightbox(key) {
      const p = previewMap[key];
      if (!p) return;
      lbTitle.textContent = p.title;
      lbImg.src = p.image;
      lb.classList.add("open");
      lb.setAttribute("aria-hidden", "false");
      document.body.style.overflow = "hidden";
    }

    function closeLightbox() {
      lb.classList.remove("open");
      lb.setAttribute("aria-hidden", "true");
      lbImg.src = "";
      document.body.style.overflow = "";
    }

    document.querySelectorAll("[data-open]").forEach((el) => {
      el.addEventListener("click", () => openLightbox(el.dataset.open));
      el.addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          openLightbox(el.dataset.open);
        }
      });
    });

    lbClose.addEventListener("click", closeLightbox);
    lb.addEventListener("click", (e) => { if (e.target === lb) closeLightbox(); });
    document.addEventListener("keydown", (e) => { if (e.key === "Escape") closeLightbox(); });
  </script>
</BaseLayout>
