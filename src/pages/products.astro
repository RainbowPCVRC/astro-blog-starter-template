---
import BaseHead from '../components/BaseHead.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import { SITE_TITLE } from '../consts';

const gumroad = "https://rainbowscreations.gumroad.com/";
const jinxxy = "https://jinxxy.com/rainbowvis";
const kofi = "https://ko-fi.com/rainbow_vis";
---

<!doctype html>
<html lang="en">
  <head>
    <BaseHead title={`${SITE_TITLE} • Products`} description="Store links + featured products." />
  </head>
  <body>
    <Header />

    <main class="page-shell">
      <header class="page-head neon-card proximity-glow">
        <div class="glow-spot"></div>
        <h1>Products</h1>
        <p>
          <span class="underline-soft">If you want quality products for a decent price, then go to my </span>
          <a class="underline-soft" href={gumroad} target="_blank" rel="noreferrer">Gumroad</a>
          <span class="underline-soft"> &amp; </span>
          <a class="underline-soft" href={jinxxy} target="_blank" rel="noreferrer">Jinxxy</a>
          <span class="underline-soft"> Links!</span>
        </p>
      </header>

      <!-- Two store boxes centered, with & between -->
      <section class="store-row">
        <article class="neon-card proximity-glow store-card store-left">
          <div class="glow-spot"></div>

          <div class="store-head">
            <span class="store-icon" aria-hidden="true">
              <!-- Gumroad-ish bag icon -->
              <svg viewBox="0 0 24 24" fill="none">
                <path d="M7 7.5A4.5 4.5 0 0 1 11.5 3h1A4.5 4.5 0 0 1 17 7.5v1A4.5 4.5 0 0 1 12.5 13h-1A4.5 4.5 0 0 1 7 8.5v-1Z" stroke="currentColor" stroke-width="1.7"/>
                <path d="M6 21h12" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/>
                <path d="M9 21v-3.2c0-1 .8-1.8 1.8-1.8h2.4c1 0 1.8.8 1.8 1.8V21" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/>
              </svg>
            </span>
            <div>
              <h2 class="store-title">Gumroad Store Link</h2>
              <a class="store-cta" href={gumroad} target="_blank" rel="noreferrer">
                Go to the Gumroad Store Page! <span class="arrow">→</span>
              </a>
            </div>
          </div>

          <p class="store-desc">
            Featured Image: Lumistera Leg Warmers V1
          </p>

          <!-- Clickable image with modal -->
          <button class="img-btn" type="button" data-open="gumroadModal" aria-label="Open Gumroad product image">
            <img
              class="store-img"
              src="/images/products/lumistera-leg-warmers.png"
              alt="Lumistera Leg Warmers product preview"
              loading="lazy"
            />
          </button>
        </article>

        <article class="neon-card proximity-glow store-card store-right">
          <div class="glow-spot"></div>

          <div class="store-head">
            <span class="store-icon" aria-hidden="true">
              <!-- Jinxxy-ish cube icon -->
              <svg viewBox="0 0 24 24" fill="none">
                <path d="M12 3l8 4.5v9L12 21l-8-4.5v-9L12 3Z" stroke="currentColor" stroke-width="1.7" stroke-linejoin="round"/>
                <path d="M12 7v10" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/>
                <path d="M7.5 10.2L12 12.5l4.5-2.3" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </span>
            <div>
              <h2 class="store-title">Jinxxy Store Link</h2>
              <a class="store-cta" href={jinxxy} target="_blank" rel="noreferrer">
                Go to Jinxxy Store Page! <span class="arrow">→</span>
              </a>
            </div>
          </div>

          <p class="store-desc">
            Featured Image: Thingy Plushie Normals on PumkinPaws avatar!
          </p>

          <button class="img-btn" type="button" data-open="jinxxyModal" aria-label="Open Jinxxy product image">
            <img
              class="store-img"
              src="/images/products/jinxxy-feature.png"
              alt="Jinxxy product preview"
              loading="lazy"
            />
          </button>
        </article>
      </section>

      <!-- Ko-fi support box bottom centered -->
      <section class="kofi-wrap">
        <article class="neon-card proximity-glow kofi-card">
          <div class="glow-spot"></div>

          <div class="kofi-head">
            <div>
              <h2>Support on Ko-fi</h2>
              <p class="kofi-desc">
                If you want to support and make RainbowVis&apos;s dreams come true, then consider supporting them on their Ko-Fi!
                There is memberships affordable for everyone! And the benefits are very great!
              </p>

              <a class="store-cta" href={kofi} target="_blank" rel="noreferrer">
                Go support RainbowVis if you want! <span class="arrow">→</span>
              </a>
            </div>

            <span class="store-icon kofi-icon" aria-hidden="true">
              <!-- Mug icon -->
              <svg viewBox="0 0 24 24" fill="none">
                <path d="M6 7h10v10a4 4 0 0 1-4 4H10a4 4 0 0 1-4-4V7Z" stroke="currentColor" stroke-width="1.7"/>
                <path d="M16 9h1.2A2.8 2.8 0 0 1 20 11.8v.4A2.8 2.8 0 0 1 17.2 15H16" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/>
                <path d="M9 6V4h4v2" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/>
              </svg>
            </span>
          </div>
        </article>
      </section>

      <!-- Modals -->
      </main>

    <Footer />
    <script is:inline src="/proximityGlow.js"></script>

    </body>
</html>
  <!-- Trello-like image viewer -->
  <div id="lightbox" class="lightbox-overlay" data-open="false" aria-hidden="true">
    <div class="neon-card lightbox-shell" role="dialog" aria-modal="true" aria-label="Image preview">
      <div class="lightbox-topbar">
        <div class="lightbox-meta">
          <div id="lightboxFilename" class="lightbox-filename">Image</div>
          <div id="lightboxSubmeta" class="lightbox-submeta">—</div>
        </div>

        <div id="lightboxClose" class="neon-card lightbox-close" aria-label="Close">
          ✕
        </div>
      </div>

      <div id="lightboxStage" class="lightbox-stage">
        <img id="lightboxImg" class="lightbox-img" alt="" />
      </div>

      <div class="lightbox-tools">
        <div class="lightbox-hint">Scroll to zoom • Drag to pan</div>

        <div id="zoomReset" class="lightbox-btn" title="Reset zoom">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-width="2" d="M21 12a9 9 0 1 1-3.3-6.9"/><path stroke-width="2" d="M21 3v6h-6"/></svg>
          Reset
        </div>

        <div id="zoomToggle" class="lightbox-btn" title="Toggle zoom">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-width="2" d="M10 18a8 8 0 1 1 5.3-14.1A8 8 0 0 1 10 18Z"/><path stroke-width="2" d="M21 21l-4.35-4.35"/><path stroke-width="2" d="M10 8v6"/><path stroke-width="2" d="M7 11h6"/></svg>
          Zoom
        </div>
      </div>
    </div>
  </div>


<script>
  (function () {
    const overlay = document.getElementById("lightbox");
    const closeBtn = document.getElementById("lightboxClose");
    const imgEl = document.getElementById("lightboxImg");
    const stage = document.getElementById("lightboxStage");
    const filenameEl = document.getElementById("lightboxFilename");
    const submetaEl = document.getElementById("lightboxSubmeta");
    const zoomToggle = document.getElementById("zoomToggle");
    const zoomReset = document.getElementById("zoomReset");

    if (!overlay || !imgEl || !stage) return;

    let scale = 1;
    let minScale = 1;
    let maxScale = 3;
    let panX = 0;
    let panY = 0;
    let isDragging = false;
    let dragStartX = 0;
    let dragStartY = 0;

    function setOpen(open) {
      overlay.dataset.open = open ? "true" : "false";
      overlay.setAttribute("aria-hidden", open ? "false" : "true");
      document.documentElement.classList.toggle("no-scroll", open);
      document.body.classList.toggle("no-scroll", open);

      if (!open) {
        // reset on close
        scale = 1;
        panX = 0;
        panY = 0;
        applyTransform();
        imgEl.src = "";
        imgEl.alt = "";
        filenameEl.textContent = "Image";
        submetaEl.textContent = "—";
      }
    }

    function applyTransform() {
      imgEl.style.transform = `translate(${panX}px, ${panY}px) scale(${scale})`;
      imgEl.style.cursor = scale > 1 ? (isDragging ? "grabbing" : "grab") : "zoom-in";
    }

    function clamp(v, min, max) {
      return Math.max(min, Math.min(max, v));
    }

    async function loadMeta(src) {
      const filename = (src.split("/").pop() || "Image").split("?")[0];
      filenameEl.textContent = filename;

      // Try HEAD first to get Content-Length
      try {
        const head = await fetch(src, { method: "HEAD" });
        const len = head.headers.get("content-length");
        if (len) {
          const mb = (Number(len) / (1024 * 1024)).toFixed(2);
          submetaEl.textContent = `${mb} MB`;
          return;
        }
      } catch {}

      // Fallback: fetch blob
      try {
        const res = await fetch(src);
        const blob = await res.blob();
        const mb = (blob.size / (1024 * 1024)).toFixed(2);
        submetaEl.textContent = `${mb} MB`;
      } catch {
        submetaEl.textContent = "—";
      }
    }

    async function openWithSrc(src) {
      imgEl.src = src;
      imgEl.alt = (src.split("/").pop() || "Image").split("?")[0];

      // reset transform
      scale = 1;
      panX = 0;
      panY = 0;
      applyTransform();

      setOpen(true);
      loadMeta(src);
    }

    // Click any product image button to open
    document.addEventListener("click", (e) => {
      const btn = e.target.closest(".img-btn");
      if (!btn) return;
      const img = btn.querySelector("img");
      if (!img || !img.src) return;
      e.preventDefault();
      openWithSrc(img.src);
    });

    function close() {
      setOpen(false);
    }

    closeBtn?.addEventListener("click", close);

    overlay.addEventListener("click", (e) => {
      // Close only when clicking outside the card
      if (e.target === overlay) close();
    });

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && overlay.dataset.open === "true") close();
    });

    // Wheel zoom
    stage.addEventListener("wheel", (e) => {
      if (overlay.dataset.open !== "true") return;
      e.preventDefault();
      const delta = e.deltaY > 0 ? -0.1 : 0.1;
      const next = clamp(scale + delta, minScale, maxScale);
      scale = next;
      applyTransform();
    }, { passive: false });

    // Toggle zoom (like Trello's magnifier after click)
    zoomToggle?.addEventListener("click", () => {
      scale = scale === 1 ? 2 : 1;
      panX = 0;
      panY = 0;
      applyTransform();
    });

    zoomReset?.addEventListener("click", () => {
      scale = 1;
      panX = 0;
      panY = 0;
      applyTransform();
    });

    // Drag to pan (only when zoomed)
    stage.addEventListener("pointerdown", (e) => {
      if (overlay.dataset.open !== "true") return;
      if (scale <= 1) return;
      isDragging = true;
      dragStartX = e.clientX - panX;
      dragStartY = e.clientY - panY;
      stage.setPointerCapture(e.pointerId);
      applyTransform();
    });

    stage.addEventListener("pointermove", (e) => {
      if (!isDragging) return;
      panX = e.clientX - dragStartX;
      panY = e.clientY - dragStartY;
      applyTransform();
    });

    stage.addEventListener("pointerup", () => {
      isDragging = false;
      applyTransform();
    });

    stage.addEventListener("pointercancel", () => {
      isDragging = false;
      applyTransform();
    });
  })();
</script>


